# 2021年5月12日

仕事がつらく厳しい。

## YubiKey

昨日の続き。

実は問題は単純でWindowsでは管理者権限がないとlibfido2がFIDO2インターフェイスにアクセスできないというだけだった。つまり管理者権限でシェルを起動してssh-keygenを叩くだけだった。別にCygwinも不要でgit for windowsでなんとかなった。

residentのオプションを付けると上手く行かないのも実は簡単で、デバッグメッセージを表示させると簡単に糸口が見つかった。FIDO2のPINが設定されていだけだった。PINはYubiKeyManagerで設定できた。のこういうときちゃんとメッセージを記録しておけば誰かの役に立つのかも知れないのだが記録を忘れていた。気をつけたい。

あとは鍵の作成時と`ssh-keygen -K`で出てくる鍵ファイルが何なのかを調べないといけない。`ssh-keygen -K`を実行すると何故か2つ鍵が出てくるが最初のほうが作成時に出てくるものと同じのようだ。これも調べないと。

解決したのはいいがSSHするたびに管理者権限が必要なのでは嬉しくないので調べていると[openssh-sk-winhello](https://github.com/tavrez/openssh-sk-winhello)とか言うものを見つけた。これはWindows HelloのAPI経由でFIDOデバイスを使用することで管理者権限が不必要になるということらしい。鍵の取り出しは上手く動かないようだが特に問題はなく使えそうだった。

まとめるとgit for windowsがあればecdsa-sk, ed25519-skのSSH鍵が使える。鍵の作成には管理者権限が必要。openssh-sk-winhelloを使えば使用時は管理者権限は不要にできる。簡単ですね。

YubiKeyは上手く使うとかなり便利だと思うのでぜひ一本購入してほしい。Yubicoから直接買うと送料とかもかかるけど比較的最新のファームウェアのものが買える。私はAmazonでよくわからないところから買ったら古いファームウェアのものがきて新しいものをもう一本買いました。ファームウェアが古いとPGPカードのバージョンも古くてecdsaやed25519の鍵が使えません。個人的にはNFC付きのものがおすすめです。私はYubiKey 5 NFCとYubiKey 5C NFCとYubiKey 5CとYubiKey 5Ci Clearを持っています。

これ書くためにYubicoのページ見てたら靴下が売っていて笑ってしまった。YubiSocksとかいう名前なのに別に5本指ソックスとかではなくて普通の靴下だった。

## あとがき

普段こういう試行錯誤の記録を残していないのでこれからは気をつけて書いていこうと思う。ガジェットを買ったときにも選定理由とか感想とか書こうとか思った。

今日の日記はメインPCで書きました。

変更履歴:  
05/13/2021 00:02:20: 20210512追加  
